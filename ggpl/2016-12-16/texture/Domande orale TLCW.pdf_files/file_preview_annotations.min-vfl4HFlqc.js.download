(function(){var t=function(t,n){return function(){return t.apply(n,arguments)}};define(["external/underscore","modules/constants/comments_panel","modules/constants/legacy","modules/core/exception","modules/clean/annotations/annotation","modules/clean/comments/store","modules/clean/comments/revisions","modules/clean/comments/utils","modules/clean/keycode","modules/clean/react/file_comments/logger","modules/clean/react/file_viewer/store","modules/clean/string"],function(n,o,e,i,a,r,s,c,l,h,u,v){var d,A,p,assert,C,y;return assert=i.assert,A=a.Annotation,y=v.lispToPascalCase,d=["annotation-hidden","annotation-placed","annotation-start-drag","annotation-end-drag","page-rendered","annotation-ui-click","annotation-ui-enter","annotation-ui-leave","annotation-enter","annotation-leave","scale-change","scroll","on-keydown","reset-file-feedback-ui","mouse-up"],C=o.ALLOW_ANNOTATION_GHOST,p=function(){function o(n){this.prevState=n.prevState,this.state=n.state,this.interfaceController=n.interfaceController,this.actionCreators=n.actionCreators,this.onResetFileFeedbackUi=t(this.onResetFileFeedbackUi,this),this.onMouseUp=t(this.onMouseUp,this),this.onOnKeydown=t(this.onOnKeydown,this),this.onScroll=t(this.onScroll,this),this.onScaleChange=t(this.onScaleChange,this),this.onAnnotationUiLeave=t(this.onAnnotationUiLeave,this),this.onAnnotationUiEnter=t(this.onAnnotationUiEnter,this),this.onAnnotationUiClick=t(this.onAnnotationUiClick,this),this.onAnnotationEndDrag=t(this.onAnnotationEndDrag,this),this.onAnnotationStartDrag=t(this.onAnnotationStartDrag,this),this.onAnnotationPlaced=t(this.onAnnotationPlaced,this),this.onAnnotationHidden=t(this.onAnnotationHidden,this),this.onStateChange=t(this.onStateChange,this)}return o.create=function(t){return new o({prevState:{activityKeys:[],hasEphemeral:!1},state:{ephemeralAnnotation:null,commentActivityByKey:{},canAnnotate:!1,regionCreationEnabled:!1,viewingAnnotationConversation:!1},interfaceController:null,actionCreators:t})},o.prototype.setState=function(t){return n.extend(this.state,t),this.performUpdateIfNecessary()},o.prototype.getStateFromStores=function(){var t,o,e,i,a;return a=r.state.showResolvedComments,o=!1,t=c.shouldShowExistingAnnotations()?r.state.activity.comment_activities.filter(function(t){var n;return t.comment.resolved&&o?!1:null!=(null!=(n=t.comment.comment_metadata)?n.annotation:void 0)}):{},{activityKey:null!=(e=r.state.activity)?e.activity_key:void 0,actorId:r.state.actorId,activityContext:r.state.viewing.context,revision:r.state.viewing.revision,commentActivityByKey:n.indexBy(t,"activity_key"),ephemeralAnnotation:null!=(i=r.state.createAnnotation)?i.annotation:void 0,canAnnotate:c.canAnnotate(),regionCreationEnabled:c.isRegionCreationEnabled(),showResolved:a,viewingAnnotationConversation:null!=r.state.viewAnnotation}},o.prototype.onStateChange=function(){return null!=r.state.activity?this.setState(this.getStateFromStores()):void 0},o.prototype.mount=function(t){return assert(null!=t,"Interface controller must not be null"),assert(!this.isMounted(),"FilePreviewAnnotations instance is already mounted"),this.prevState={},this.interfaceController=t,this.onStateChange(r.state),this.unsubscribeStore=r.listen(this.onStateChange),this.unsubscribeFileViewerStore=u.addListener(this.onStateChange),this.addAnnotationEventListeners(),this.performUpdateIfNecessary()},o.prototype.unmount=function(){return assert(this.isMounted(),"FilePreviewAnnotations instance is not mounted"),this.unsubscribeStore(),"function"==typeof this.unsubscribeFileViewerStore&&this.unsubscribeFileViewerStore(),this.disableAnnotationCreation(),this.removeAnnotationEventListeners(),this.interfaceController=null,window.clearTimeout(this.annotationBubbleTimer)},o.prototype.isMounted=function(){return null!=this.interfaceController},o.prototype.enableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("enable-annotation-creation")},o.prototype.disableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("disable-annotation-creation")},o.prototype.enableRegionCreation=function(){return this.interfaceController.dispatchEvent("enable-region-creation")},o.prototype.disableRegionCreation=function(){return this.interfaceController.dispatchEvent("disable-region-creation")},o.prototype.addAnnotationEventListeners=function(){return d.forEach(function(t){return function(n){var o,e;return e="on"+y(n),o=t[e],null!=o?t.interfaceController.on(n,o):void 0}}(this))},o.prototype.removeAnnotationEventListeners=function(){return d.forEach(function(t){return function(n){var o,e;return e="on"+y(n),o=t[e],null!=o?t.interfaceController.off(n,o):void 0}}(this))},o.prototype.onAnnotationHidden=function(t){return this.actionCreators.stopAnnotationCreation()},o.prototype.onAnnotationPlaced=function(t){var n;return n=A.createAnnotationFromDict(t.annotation),this.actionCreators.startAnnotationCreation({annotation:n}),h.log_annotation_event(e.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_PLACED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},o.prototype.onAnnotationStartDrag=function(t){return this.actionCreators.hideAnnotationConversation(),this.actionCreators.hideAnnotationInput()},o.prototype.onAnnotationEndDrag=function(t){var n;return this.actionCreators.hideAnnotationConversation(),n=A.createAnnotationFromDict(t.annotation),this.actionCreators.startAnnotationCreation({annotation:n}),h.log_annotation_event(e.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_DRAGGED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},o.prototype.onAnnotationUiClick=function(t){var n,o;return n=t.commentActivity.activity_key,this.actionCreators.revealAnnotationInPreview(n),this.actionCreators.revealCommentInPane({activityKey:n,expandConversation:!1}),h.log_annotation_event(e.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_CLICKED,this.state.activityKey,null!=(o=t.commentActivity)?o.activity_key:void 0,this.state.actorId,this.state.activityContext)},o.prototype.onAnnotationUiEnter=function(t){var n,o;if(null==this.state.ephemeralAnnotation&&(null!=(n=r.state.viewAnnotation)?!n.replyFocused:!0))return this.actionCreators.showAnnotationConversation({activityKey:t.commentActivity.activity_key,annotation:A.createAnnotationFromDict(t.annotation)}),h.log_annotation_event(e.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_HOVER,this.state.activityKey,null!=(o=t.commentActivity)?o.activity_key:void 0,this.state.actorId,this.state.activityContext)},o.prototype.onAnnotationUiLeave=function(t){var n,o;return this.actionCreators.updateAnnotationUiHover(!1),null!=this.state.ephemeralAnnotation||(null!=(o=r.state.viewAnnotation)?o.replyFocused:0)?void 0:(n=function(t){return function(){var n,o;return!t.isMounted()||(null!=(n=r.state.viewAnnotation)?n.conversationHover:void 0)||(null!=(o=r.state.viewAnnotation)?o.annotationHover:void 0)?void 0:t.actionCreators.hideAnnotationConversation()}}(this),window.setTimeout(n,50))},o.prototype.onScaleChange=function(t){return this.actionCreators.stopAnnotationCreation(),this.actionCreators.hideAnnotationConversation()},o.prototype.onScroll=function(t){var o;return this.actionCreators.hideAnnotationInput(),this.actionCreators.hideAnnotationConversation(),window.clearTimeout(this.annotationBubbleTimer),o=n.partial(function(t){return function(n){var o;return null!=(null!=n?n.annotation:void 0)?(o=A.createAnnotationFromDict(n.annotation),t.actionCreators.startAnnotationCreation({annotation:o})):t.actionCreators.showAnnotationInput()}}(this),t),this.annotationBubbleTimer=window.setTimeout(o,150)},o.prototype.onOnKeydown=function(t){return c.normalizedKeyCode.apply(t)===l.ESC?this.actionCreators.stopAnnotationCreation():void 0},o.prototype.onMouseUp=function(t){return null!=this.state.viewingAnnotationConversation?this.actionCreators.hideAnnotationConversation():void 0},o.prototype.onResetFileFeedbackUi=function(t){return this.actionCreators.stopAnnotationCreation(),this.actionCreators.hideAnnotationConversation()},o.prototype._savePrevState=function(){var t;return this.prevState={activityKeys:Object.keys(null!=(t=this.state.commentActivityByKey)?t:{}),hasEphemeral:null!=this.state.ephemeralAnnotation,canAnnotate:this.state.canAnnotate,regionCreationEnabled:this.state.regionCreationEnabled,viewingAnnotationConversation:this.state.viewingAnnotationConversation}},o.prototype._removeAnnotation=function(t){return this.interfaceController.dispatchEvent("remove-annotation",{commentActivity:{activity_key:t}})},o.prototype._updateAnnotations=function(t){var n,o,e,i,a,r,c,l,h,u;for(e=[],o=0,a=0,l=t.length;l>a;a++)i=t[a],i.comment.hasMetadata()&&i.comment.comment_metadata.hasAnnotationData()&&(o+=1,!this.state.showResolved&&i.comment.resolved||(h=i.comment.comment_metadata,n=h.annotation,u=h.revision,r=s.isRevisionEqual(this.state.revision,u),(C||null!=u&&r)&&(c=C&&null!=u&&!r,e.push({annotation:n,commentActivity:i,options:{isGhostAnnotation:c,isAnnotationNumberingEnabled:!0,annotationNumber:o}}))));return this.interfaceController.dispatchEvent("update-annotations",{annotations:e})},o.prototype.performUpdateIfNecessary=function(){var t,o;if(this.isMounted())return n.isEmpty(this.state.commentActivityByKey)?this.interfaceController.dispatchEvent("remove-all-annotations"):(t=n.difference(null!=(o=this.prevState.activityKeys)?o:[],Object.keys(this.state.commentActivityByKey)),t.forEach(this._removeAnnotation,this),this._updateAnnotations(n.values(this.state.commentActivityByKey))),this.prevState.hasEphemeral&&null==this.state.ephemeralAnnotation&&this.interfaceController.dispatchEvent("hide-annotation"),this.prevState.canAnnotate!==this.state.canAnnotate&&(this.state.canAnnotate?this.enableAnnotationCreation():this.disableAnnotationCreation()),this.prevState.regionCreationEnabled!==this.state.regionCreationEnabled&&(this.state.regionCreationEnabled?this.enableRegionCreation():this.disableRegionCreation()),this.prevState.viewingAnnotationConversation!==this.state.viewingAnnotationConversation&&(this.state.viewingAnnotationConversation?this.disableRegionCreation():this.state.regionCreationEnabled&&this.enableRegionCreation()),this._savePrevState()},o}()})}).call(this);
//# sourceMappingURL=file_preview_annotations.min.js-vflg1eM-J.map